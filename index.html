<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live UK Cash Flow Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#10b981',
                        'secondary-blue': '#3b82f6',
                        'danger-red': '#ef4444',
                        'safe-green': '#10b981',
                        'flow-in': '#10b981',
                        'flow-out': '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles */
        body {
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Chart specific styles to ensure responsiveness */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }

        /* Responsive adjustments for KPI grid */
        @media (max-width: 1024px) {
            #kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-container {
                height: 50vh;
            }
        }
        @media (max-width: 640px) {
            #kpi-grid {
                grid-template-columns: repeat(1, 1fr);
            }
        }
    </style>
</head>
<body class="font-sans p-4 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 md:mb-0">UK Cash Flow Dashboard</h1>
            <button id="refresh-button" class="bg-secondary-blue hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m9.673 0H12v5m7.356 2A8.001 8.001 0 014.582 15m9.673 0H12v5"></path></svg>
                Refresh Data (Simulated Live)
            </button>
        </header>

        <!-- KPI Grid -->
        <div id="kpi-grid" class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            <!-- KPI 1: Current Cash Balance (Now derived from Running Balance) -->
            <div class="card bg-white p-5 rounded-xl border-t-4 border-secondary-blue">
                <div class="flex items-center">
                    <span class="text-xs font-semibold uppercase text-gray-500 tracking-wider">Current Cash Balance</span>
                </div>
                <p id="kpi-balance" class="text-3xl font-extrabold mt-1 text-gray-900">£0</p>
                <p class="text-sm text-gray-500 mt-1">Closing balance from transactions</p>
            </div>

            <!-- KPI 2: Net Operating Cash Flow (Last Month) -->
            <div class="card bg-white p-5 rounded-xl border-t-4 border-flow-in">
                <div class="flex items-center">
                    <span class="text-xs font-semibold uppercase text-gray-500 tracking-wider">Net OCF (Last Month)</span>
                </div>
                <p id="kpi-net-ocf" class="text-3xl font-extrabold mt-1 text-gray-900">£0</p>
                <p id="kpi-ocf-change" class="text-sm text-gray-500 mt-1">Operating activity only</p>
            </div>

            <!-- KPI 3: Average Monthly Inflow (Replaced Cash Runway) -->
            <div class="card bg-white p-5 rounded-xl border-t-4 border-yellow-500">
                <div class="flex items-center">
                    <span class="text-xs font-semibold uppercase text-gray-500 tracking-wider">Average Monthly Inflow</span>
                </div>
                <p id="kpi-avg-inflow" class="text-3xl font-extrabold mt-1 text-gray-900">£0</p>
                <p class="text-sm text-gray-500 mt-1">Avg. cash received per month</p>
            </div>

             <!-- KPI 4: Average Monthly Spend (Replaced DSO) -->
            <div class="card bg-white p-5 rounded-xl border-t-4 border-flow-out">
                <div class="flex items-center">
                    <span class="text-xs font-semibold uppercase text-gray-500 tracking-wider">Average Monthly Spend</span>
                </div>
                <p id="kpi-avg-spend" class="text-3xl font-extrabold mt-1 text-gray-900">£0</p>
                <p class="text-sm text-gray-500 mt-1">Avg. cash spent per month</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Chart 1: Monthly Cash Flow (Inflows vs. Outflows) -->
            <div class="card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Monthly Inflows vs. Outflows</h2>
                <div class="chart-container">
                    <canvas id="monthlyFlowChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Cumulative Cash Position -->
            <div class="card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Cumulative Cash Position Over Time</h2>
                <div class="chart-container">
                    <canvas id="cumulativeCashChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Data Uploader Section -->
        <div class="card bg-white p-6 rounded-xl mb-8 border-l-4 border-primary-green">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Upload Cash Transactions (CSV)</h2>
            <p class="text-sm text-gray-600 mb-4">Upload a CSV file with the headers: <code class="bg-gray-100 p-1 rounded">Date,Description,Category,Amount,Running Balance</code></p>
            <input type="file" id="csvFileInput" accept=".csv" class="w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-secondary-blue/10 file:text-secondary-blue
                hover:file:bg-secondary-blue/20
            ">
            <p id="upload-status" class="text-sm mt-2 text-gray-700"></p>
        </div>

        <!-- Transactions Table (Updated to Top 7 by Magnitude) -->
        <div class="card bg-white p-6 rounded-xl">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Top 7 Transactions (by Magnitude)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (£)</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                        <!-- Transactions will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- DATA AND INITIALIZATION ---
        const currencySymbol = '£';

        // Updated MOCK Data Structure including Running Balance
        const INITIAL_TRANSACTIONS = [
            // Date, Description, Category, Amount, Running Balance
            { date: '2023-07-01', description: 'Initial Capital Injection', category: 'Financing', amount: 50000.00, runningBalance: 50000.00 },
            { date: '2023-07-15', description: 'July Sales Collections', category: 'Operating', amount: 85000.00, runningBalance: 135000.00 },
            { date: '2023-07-31', description: 'July Operational Costs', category: 'Operating', amount: -72000.00, runningBalance: 63000.00 },
            { date: '2023-08-01', description: 'August Sales Collections', category: 'Operating', amount: 92000.00, runningBalance: 155000.00 },
            { date: '2023-08-15', description: 'August Payroll', category: 'Operating', amount: -88000.00, runningBalance: 67000.00 },
            { date: '2023-09-05', description: 'New Loan Drawdown', category: 'Financing', amount: 15000.00, runningBalance: 82000.00 },
            { date: '2023-09-08', description: 'September Sales Collections', category: 'Operating', amount: 110000.00, runningBalance: 192000.00 },
            { date: '2023-09-30', description: 'September Costs', category: 'Operating', amount: -95000.00, runningBalance: 97000.00 },
            { date: '2023-10-10', description: 'October Sales Collections', category: 'Operating', amount: 125000.00, runningBalance: 222000.00 },
            { date: '2023-10-25', description: 'Large Equipment Purchase', category: 'Investing', amount: -140000.00, runningBalance: 82000.00 }, // Large outflow
            { date: '2023-11-01', description: 'November Sales Collections', category: 'Operating', amount: 100000.00, runningBalance: 182000.00 },
            { date: '2023-11-15', description: 'November Costs', category: 'Operating', amount: -75000.00, runningBalance: 107000.00 },
            // Recent Transactions (Dec 23)
            { date: '2023-12-07', description: 'Web Hosting Renewal', category: 'IT/Tech', amount: -250.00, runningBalance: 106750.00 },
            { date: '2023-12-08', description: 'Client Invoice - Project Alpha', category: 'Sales', amount: 12500.00, runningBalance: 119250.00 },
            { date: '2023-12-08', description: 'Staff Payroll Deposit', category: 'Personnel', amount: -8500.00, runningBalance: 110750.00 },
            { date: '2023-12-09', description: 'Office Supplies (Rymans)', category: 'Admin', amount: -45.50, runningBalance: 110704.50 },
            { date: '2023-12-10', description: 'Client Invoice - Project Beta', category: 'Sales', amount: 5500.00, runningBalance: 116204.50 },
        ].sort((a, b) => new Date(a.date) - new Date(b.date)); 

        let currentTransactions = [...INITIAL_TRANSACTIONS];
        let flowChart, cumulativeChart;

        // Utility function to format numbers as GBP currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-GB', {
                style: 'currency',
                currency: 'GBP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        // Utility to get YYYY-MM key
        const getMonthKey = (dateString) => {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        };
        
        // --- DATA PROCESSING LOGIC ---

        const aggregateTransactions = (transactions) => {
            if (transactions.length === 0) {
                 return { processedData: [], totalBalance: 0, netOCF: 0, avgInflow: 0, avgOutflow: 0 };
            }
            
            const monthlyAggregates = {};
            let totalInflows = 0;
            let totalOutflows = 0;

            // 1. Process all transactions to calculate monthly flows
            transactions.forEach(tx => {
                const dateKey = getMonthKey(tx.date);
                const amount = parseFloat(tx.amount);

                if (!monthlyAggregates[dateKey]) {
                    // Store the first date in the month for labeling
                    monthlyAggregates[dateKey] = { inflows: 0, outflows: 0, date: tx.date };
                }

                if (amount >= 0) {
                    monthlyAggregates[dateKey].inflows += amount;
                    totalInflows += amount;
                } else {
                    monthlyAggregates[dateKey].outflows += Math.abs(amount);
                    totalOutflows += Math.abs(amount);
                }
            });

            // 2. Build the final processed array and calculate cumulative figures (using Running Balance)
            const sortedKeys = Object.keys(monthlyAggregates).sort();
            
            // To calculate cumulative cash correctly for the chart, we need to know the opening balance.
            const initialBalance = transactions[0].runningBalance - transactions[0].amount;
            let currentCumulative = initialBalance;

            const processedData = sortedKeys.map(key => {
                const item = monthlyAggregates[key];
                const netCashFlow = item.inflows - item.outflows;
                currentCumulative += netCashFlow;
                
                return {
                    date: new Date(item.date).toLocaleDateString('en-GB', { month: 'short', year: '2-digit' }),
                    inflows: item.inflows,
                    outflows: item.outflows,
                    netCashFlow: netCashFlow,
                    cumulativeCash: currentCumulative
                };
            });

            // 3. Calculate KPIs
            const latestData = processedData[processedData.length - 1] || { netCashFlow: 0 };
            const numMonths = processedData.length;

            return {
                processedData,
                latest: latestData,
                totalBalance: transactions[transactions.length - 1].runningBalance, // Use last running balance
                netOCF: latestData.netCashFlow,
                avgInflow: numMonths > 0 ? totalInflows / numMonths : 0,
                avgOutflow: numMonths > 0 ? totalOutflows / numMonths : 0,
            };
        };

        const parseCSV = (csvText) => {
            const transactions = [];
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length <= 1) {
                return { success: false, message: "CSV file is empty or missing data." };
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const expectedHeaders = ['Date', 'Description', 'Category', 'Amount', 'Running Balance'];
            
            if (headers.length !== expectedHeaders.length || headers.some((h, i) => h !== expectedHeaders[i])) {
                return { success: false, message: `Invalid CSV format. Expected headers: ${expectedHeaders.join(', ')}` };
            }

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length === headers.length) {
                    const amount = parseFloat(values[3]);
                    const runningBalance = parseFloat(values[4]);
                    const date = values[0];

                    if (isNaN(amount) || isNaN(runningBalance) || isNaN(new Date(date))) {
                        return { success: false, message: `Error on line ${i + 1}: Invalid Date, Amount, or Running Balance value.` };
                    }
                    
                    transactions.push({
                        date: date,
                        description: values[1],
                        category: values[2],
                        amount: amount,
                        runningBalance: runningBalance,
                        // Flag potential Operating Inflow items for Net OCF calculation
                        isOperatingInflow: values[2] === 'Sales' || values[2] === 'Operating' && amount > 0, 
                    });
                }
            }
            // Sort by date before returning
            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            return { success: true, data: transactions, message: `Successfully loaded ${transactions.length} transactions.` };
        };

        // --- RENDER FUNCTIONS ---

        const updateKPIs = (metrics) => {
            const { totalBalance, netOCF, avgInflow, avgOutflow } = metrics;

            document.getElementById('kpi-balance').textContent = formatCurrency(totalBalance);

            // Net OCF coloring
            const ocfElement = document.getElementById('kpi-net-ocf');
            const ocfChangeElement = document.getElementById('kpi-ocf-change');
            ocfElement.textContent = formatCurrency(Math.abs(netOCF));
            ocfElement.classList.remove('text-safe-green', 'text-danger-red');

            if (netOCF >= 0) {
                ocfElement.classList.add('text-safe-green');
                ocfChangeElement.textContent = 'Cash Surplus';
                ocfChangeElement.classList.remove('text-danger-red');
                ocfChangeElement.classList.add('text-safe-green');
            } else {
                ocfElement.classList.add('text-danger-red');
                ocfChangeElement.textContent = 'Cash Deficit';
                ocfChangeElement.classList.remove('text-safe-green');
                ocfChangeElement.classList.add('text-danger-red');
            }

            // Average Monthly Inflow (KPI 3)
            const inflowElement = document.getElementById('kpi-avg-inflow');
            inflowElement.textContent = formatCurrency(avgInflow);
            inflowElement.classList.remove('text-safe-green', 'text-danger-red', 'text-yellow-500');
            inflowElement.classList.add('text-secondary-blue');

            // Average Monthly Spend (KPI 4)
            const spendElement = document.getElementById('kpi-avg-spend');
            spendElement.textContent = formatCurrency(avgOutflow);
            spendElement.classList.remove('text-safe-green', 'text-danger-red', 'text-yellow-500');
            spendElement.classList.add('text-flow-out');

        };

        const renderCharts = (data) => {
            const labels = data.map(d => d.date);
            const inflows = data.map(d => d.inflows);
            const outflows = data.map(d => d.outflows);
            const cumulative = data.map(d => d.cumulativeCash);

            const monthlyCtx = document.getElementById('monthlyFlowChart').getContext('2d');
            const cumulativeCtx = document.getElementById('cumulativeCashChart').getContext('2d');

            // Destroy existing charts if they exist to prevent memory leaks/overlap
            if (flowChart) flowChart.destroy();
            if (cumulativeChart) cumulativeChart.destroy();

            // Chart 1: Monthly Cash Flow
            flowChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Inflows (£)',
                            data: inflows,
                            backgroundColor: 'rgb(16, 185, 129, 0.8)', // flow-in
                            borderRadius: 6,
                        },
                        {
                            label: 'Outflows (£)',
                            data: outflows,
                            backgroundColor: 'rgb(239, 68, 68, 0.8)', // flow-out
                            borderRadius: 6,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { drawBorder: false },
                            ticks: { callback: (value) => formatCurrency(value) }
                        }
                    }
                }
            });

            // Chart 2: Cumulative Cash Position
            cumulativeChart = new Chart(cumulativeCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative Cash (£)',
                        data: cumulative,
                        borderColor: 'rgb(59, 130, 246)', // secondary-blue
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { drawBorder: false },
                            ticks: { callback: (value) => formatCurrency(value) }
                        }
                    }
                }
            });
        };

        const renderTransactions = (transactions) => {
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            
            // Sort by the absolute value of amount (magnitude) descending
            const topTransactions = [...transactions]
                .sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount))
                .slice(0, 7); // Take the top 7

            if (topTransactions.length === 0) {
                 const row = document.createElement('tr');
                 row.innerHTML = `<td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No transactions found to display.</td>`;
                 list.appendChild(row);
                 return;
            }

            topTransactions.forEach(tx => {
                const isDebit = tx.amount < 0;
                const amountClass = isDebit ? 'text-flow-out' : 'text-flow-in';
                const formattedAmount = formatCurrency(tx.amount);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tx.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">${tx.category}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-right ${amountClass}">${formattedAmount}</td>
                `;
                list.appendChild(row);
            });
        };

        // --- HANDLERS AND MAIN LOGIC ---
        
        const updateStatus = (message, isError = false) => {
            const statusElement = document.getElementById('upload-status');
            statusElement.textContent = message;
            statusElement.className = `text-sm mt-2 font-medium ${isError ? 'text-danger-red' : 'text-flow-in'}`;
        }

        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            updateStatus("Processing file...", false);

            const reader = new FileReader();
            reader.onload = (e) => {
                const csvText = e.target.result;
                const parseResult = parseCSV(csvText);

                if (parseResult.success) {
                    currentTransactions = parseResult.data;
                    initializeDashboard(currentTransactions);
                    updateStatus(parseResult.message, false);
                } else {
                    initializeDashboard([]); // Clear dashboard on error
                    updateStatus(`Error: ${parseResult.message}`, true);
                }
            };
            reader.onerror = () => {
                updateStatus("Error reading file.", true);
            };
            reader.readAsText(file);
        };

        const initializeDashboard = (transactions) => {
            if (transactions.length === 0) {
                 // Clear previous data if no transactions loaded
                 updateKPIs({ totalBalance: 0, netOCF: 0, avgInflow: 0, avgOutflow: 0 });
                 renderCharts([]);
                 renderTransactions([]);
                 return;
            }
            
            // 1. Calculate and derive all necessary metrics
            const metrics = aggregateTransactions(transactions);

            // 2. Update KPI Cards
            updateKPIs(metrics);

            // 3. Render Charts
            renderCharts(metrics.processedData);

            // 4. Render Transaction List
            renderTransactions(transactions);

            console.log('Dashboard initialized with new data.');
        };

        // Simulation of "Live" Data Refresh (pushes small new mock transaction)
        const refreshData = () => {
            console.log('Simulating fetching live data...');

            // Calculate the running balance for the new transaction
            const lastBalance = currentTransactions.length > 0 ? currentTransactions[currentTransactions.length - 1].runningBalance : 0;
            const newAmount = -(1000 * Math.random());
            
            // Simulate a new transaction
            const newTransaction = {
                date: new Date().toISOString().slice(0, 10),
                description: 'Server Maintenance (Simulated)',
                category: 'Operating',
                amount: newAmount,
                runningBalance: lastBalance + newAmount
            };
            
            // Add new transaction to the current data set
            currentTransactions.push(newTransaction);
            currentTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));


            // Re-initialize the dashboard with the updated data
            initializeDashboard(currentTransactions);
            
            // Add a small visual confirmation
            document.getElementById('refresh-button').textContent = 'Data Refreshed!';
            setTimeout(() => {
                document.getElementById('refresh-button').innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m9.673 0H12v5m7.356 2A8.001 8.001 0 014.582 15m9.673 0H12v5"></path></svg>
                    Refresh Data (Simulated Live)
                `;
            }, 1500);
        };

        // Attach event listeners
        document.getElementById('refresh-button').addEventListener('click', refreshData);
        document.getElementById('csvFileInput').addEventListener('change', handleFileUpload);

        // Run the dashboard initialization when the window loads
        window.onload = () => {
            initializeDashboard(INITIAL_TRANSACTIONS);
            updateStatus("Dashboard loaded with initial mock data. Upload a file to update.", false);
        };

    </script>
</body>
</html>
